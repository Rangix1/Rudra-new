// Dependencies already listed in config: "path": "", "fs-extra": ""
// рдпрд╣ рдХреЛрдб Google Translate TTS API рдХрд╛ рд╕реАрдзрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ global.utils.downloadFile рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗред
// рдпрд╣ рдкрд┐рдЫрд▓реЗ рд╡рд░реНрдЬрди рд╕реЗ рдЕрд▓рдЧ рд╣реИ рдФрд░ node-gtts рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред

module.exports.config = {
    name: "say",
    version: "1.0.3", // рд╡рд░реНрдЬрди рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
    hasPermssion: 0,
    credits: "ЁЭРПЁЭРлЁЭРвЁЭР▓ЁЭРЪЁЭРзЁЭРмЁЭРб ЁЭРСЁЭРЪЁЭРгЁЭРйЁЭРоЁЭРн and Adapted", // рдЕрдкрдирд╛ рдирд╛рдо рд▓рд┐рдЦреЗрдВ рдФрд░ рдЕрдиреБрдХреВрд▓рди рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рдХрд░реЗрдВ
    description: "Make the bot return Google's audio file via text in specified language.",
    commandCategory: "media",
    usages: "[lang] [Text] or reply to a message with [lang] [text (optional)]", // рдЙрдкрдпреЛрдЧ рдХрд╛ рддрд░реАрдХрд╛ рд╕реНрдкрд╖реНрдЯ рдХрд░реЗрдВ
    // рд╕рдорд░реНрдерд┐рдд рднрд╛рд╖рд╛рдПрдБ (Google Translate TTS рдХреЗ рдЖрдзрд╛рд░ рдкрд░): ru, en, pt, ja, tl, ko, hi
    // рд╣рд░рд┐рдпрд╛рдгрд╡реА рд╕реАрдзреЗ рддреМрд░ рдкрд░ рд╕рдкреЛрд░реНрдЯ рдирд╣реАрдВ рд╣реИред
    cooldowns: 5,
    dependencies: { // рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдпреЗ рдкреИрдХреЗрдЬ рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реИрдВ
        "path": "",
        "fs-extra": ""
    }
};

module.exports.run = async function({ api, event, args }) {
    try {
        // рдЧреНрд▓реЛрдмрд▓ node_module рд╕реЗ рдЖрд╡рд╢реНрдпрдХ рдлрдВрдХреНрд╢рдиреНрд╕ рд▓реЗрдВ
        const { createReadStream, unlinkSync, ensureDirSync } = global.nodemodule["fs-extra"]; // ensureDirSync рдЬреЛрдбрд╝рд╛
        const { resolve } = global.nodemodule["path"];

        let languageToSay = global.config.language || 'en'; // рдмреЙрдЯ config рд╕реЗ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рднрд╛рд╖рд╛ рдпрд╛ 'en'
        let textToSay = "";
        const firstArg = args[0]?.toLowerCase();

        // Google Translate TTS рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдерд┐рдд рднрд╛рд╖рд╛рдПрдБ
        // 'pr' рдХреЛ рд╕рдВрднрд╛рд╡рд┐рдд рдЯрд╛рдЗрдкреЛ рдорд╛рдирдХрд░ 'pt' (Portuguese) рдореЗрдВ рдмрджрд▓рд╛ рдЧрдпрд╛ рд╣реИред 'hi' (Hindi) рдФрд░ 'ko' (Korean) рдЬреЛрдбрд╝реЗ рдЧрдП рд╣реИрдВред
        // рд╣рд░рд┐рдпрд╛рдгрд╡реА (Haryanvi) Google Translate TTS рджреНрд╡рд╛рд░рд╛ рд╕реАрдзреЗ рд╕рдорд░реНрдерд┐рдд рдирд╣реАрдВ рд╣реИред
        const supportedLanguages = ['ru', 'en', 'pt', 'ja', 'tl', 'ko', 'hi'];

        // рдЗрдирдкреБрдЯ (рд░рд┐рдкреНрд▓рд╛рдИ рдпрд╛ рдбрд╛рдпрд░реЗрдХреНрдЯ рдХрдорд╛рдВрдб) рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЯреЗрдХреНрд╕реНрдЯ рдФрд░ рднрд╛рд╖рд╛ рддрдп рдХрд░реЗрдВ
        if (event.type === "message_reply") {
            // рдпрджрд┐ рд░рд┐рдкреНрд▓рд╛рдИ рд╣реИ, рддреЛ рд░рд┐рдкреНрд▓рд╛рдИ рдореИрд╕реЗрдЬ рдХрд╛ рдЯреЗрдХреНрд╕реНрдЯ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
            textToSay = event.messageReply.body;

            // рдпрджрд┐ рд░рд┐рдкреНрд▓рд╛рдИ рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдкрд╣рд▓рд╛ рдЖрд░реНрдЧреБрдореЗрдВрдЯ рднрд╛рд╖рд╛ рдХреЛрдб рд╣реИ (рдЬреИрд╕реЗ /say hi рдХреЗ рд╕рд╛рде рд░рд┐рдкреНрд▓рд╛рдИ)
            if (args.length > 0 && supportedLanguages.includes(firstArg)) {
                 languageToSay = firstArg;
                 // рдзреНрдпрд╛рди рджреЗрдВ: рд░рд┐рдкреНрд▓рд╛рдИ рдХреЗ рд╕рд╛рде рдЯрд╛рдЗрдк рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЕрддрд┐рд░рд┐рдХреНрдд рдЯреЗрдХреНрд╕реНрдЯ (args[1] рдФрд░ рдЖрдЧреЗ) TTS рдХрдВрдЯреЗрдВрдЯ рдХреЗ рд▓рд┐рдП рдЕрдирджреЗрдЦрд╛ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред
            }

            // рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рд░рд┐рдкреНрд▓рд╛рдИ рдореИрд╕реЗрдЬ рдореЗрдВ рдЯреЗрдХреНрд╕реНрдЯ рдерд╛
            if (!textToSay || textToSay.trim().length === 0) {
                 return api.sendMessage("ЁЯд╖тАНтЩАя╕П рд░рд┐рдкреНрд▓рд╛рдИ рдореИрд╕реЗрдЬ рдореЗрдВ рдХреЛрдИ рдЯреЗрдХреНрд╕реНрдЯ рдирд╣реАрдВ рд╣реИ рдЬрд┐рд╕реЗ рд╡реЙрдпрд╕ рдореЗрдВ рдмрджрд▓ рд╕рдХреВрдВред", event.threadID, event.messageID);
            }

        } else { // рдпрджрд┐ рдбрд╛рдпрд░реЗрдХреНрдЯ рдХрдорд╛рдВрдб рд╣реИ
            // рдЪреЗрдХ рдХрд░реЗрдВ рдХрд┐ рдкрд╣рд▓рд╛ рдЖрд░реНрдЧреБрдореЗрдВрдЯ рд╕рдорд░реНрдерд┐рдд рднрд╛рд╖рд╛ рдХреЛрдб рд╣реИ
            if (args.length > 0 && supportedLanguages.includes(firstArg)) {
                // рдкрд╣рд▓рд╛ рдЖрд░реНрдЧреБрдореЗрдВрдЯ рд╕рдВрднрд╛рд╡рд┐рдд рднрд╛рд╖рд╛ рдХреЛрдб рд╣реИ
                // рдЪреЗрдХ рдХрд░реЗрдВ рдХрд┐ рднрд╛рд╖рд╛ рдХреЛрдб рдХреЗ рдмрд╛рдж рдЯреЗрдХреНрд╕реНрдЯ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВ
                if (args.length < 2) {
                    // рдХреЗрд╡рд▓ рднрд╛рд╖рд╛ рдХреЛрдб рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЙрд╕рдХреЗ рдмрд╛рдж рдЯреЗрдХреНрд╕реНрдЯ рдирд╣реАрдВ рд╣реИ
                    return api.sendMessage(`ЁЯдФ рдХреГрдкрдпрд╛ ${firstArg} рднрд╛рд╖рд╛ рдореЗрдВ рдмреЛрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдХреНрд╕реНрдЯ рджреЗрдВред\nрдЙрджрд╛рд╣рд░рдг: рдЖрдкрдХреЗ рдХрдорд╛рдВрдб рдХрд╛Prefix say ${firstArg} рдЖрдкрдХрд╛ рдЯреЗрдХреНрд╕реНрдЯ`, event.threadID, event.messageID);
                }
                // рднрд╛рд╖рд╛ рдХреЛрдб рдорд┐рд▓ рдЧрдпрд╛ рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж рдЯреЗрдХреНрд╕реНрдЯ рднреА рд╣реИ
                languageToSay = firstArg;
                textToSay = args.slice(1).join(" "); // рдкрд╣рд▓реЗ рдЖрд░реНрдЧреБрдореЗрдВрдЯ (рднрд╛рд╖рд╛ рдХреЛрдб) рдХреЗ рдмрд╛рдж рдХрд╛ рд╕рд╛рд░рд╛ рдЯреЗрдХреНрд╕реНрдЯ рд▓реЗрдВ
            } else {
                // рдкрд╣рд▓рд╛ рдЖрд░реНрдЧреБрдореЗрдВрдЯ рднрд╛рд╖рд╛ рдХреЛрдб рдирд╣реАрдВ рд╣реИ (рдпрд╛ рдХреЛрдИ рдЖрд░реНрдЧреБрдореЗрдВрдЯ рдирд╣реАрдВ рд╣реИ)ред
                // рдорд╛рди рд▓реЗрдВ рдХрд┐ рд╕рднреА рдЖрд░реНрдЧреБрдореЗрдВрдЯ рдмреЛрд▓рдиреЗ рд╡рд╛рд▓рд╛ рдЯреЗрдХреНрд╕реНрдЯ рд╣реИрдВред
                textToSay = args.join(" ");
                // рднрд╛рд╖рд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╣реА рд░рд╣реЗрдЧреАред
            }

            // рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдкрд╛рд░реНрд╕рд┐рдВрдЧ рдХреЗ рдмрд╛рдж textToSay рдЦрд╛рд▓реА рди рд╣реЛ
             if (!textToSay || textToSay.trim().length === 0) {
                 // рдпрд╣ рдЪреЗрдХ рдКрдкрд░ рдХреА рд▓реЙрдЬрд┐рдХ рджреНрд╡рд╛рд░рд╛ рдХрд╡рд░ рд╣реЛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рд▓реЗрдХрд┐рди рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП рд╣реИ
                return api.sendMessage("ЁЯТм рдХреГрдкрдпрд╛ рдЯреЗрдХреНрд╕реНрдЯ рджреЗрдВ рдЬрд┐рд╕реЗ рдЖрдк рд╡реЙрдпрд╕ рдореЗрдВ рдмрджрд▓рд╡рд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред", event.threadID, event.messageID);
            }
        }

        // рдЕрдм textToSay рдореЗрдВ рдмреЛрд▓рдиреЗ рд╡рд╛рд▓рд╛ рдЯреЗрдХреНрд╕реНрдЯ рдФрд░ languageToSay рдореЗрдВ рднрд╛рд╖рд╛ рдХреЛрдб рд╣реИред

        // Mirai рдХреЗ cache рдлреЛрд▓реНрдбрд░ рдореЗрдВ рдЕрд╕реНрдерд╛рдпреА рдСрдбрд┐рдпреЛ рдлрд╛рдЗрд▓ рдХрд╛ рдкрд╛рде рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░реЗрдВ
        // __dirname рдХрдорд╛рдВрдб рдлрд╛рдЗрд▓ рдХреЗ рдкрд╛рд╕ рдХрд╛ рдлреЛрд▓реНрдбрд░ рд╣реИред
        const cacheFolder = resolve(__dirname, 'cache');
        // рдХреЙрдиреНрдлреНрд▓рд┐рдХреНрдЯ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдлрд╝рд╛рдЗрд▓ рдирд╛рдо рдореЗрдВ рдереНрд░реЗрдб ID, рд╕реЗрдВрдбрд░ ID рдФрд░ рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рд╢рд╛рдорд┐рд▓ рдХрд░реЗрдВред
        const audioFilePath = resolve(cacheFolder, `${event.threadID}_${event.senderID}_${Date.now()}.mp3`);

        // рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ cache рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореМрдЬреВрдж рд╣реИ (Synchronously using fs-extra)
        ensureDirSync(cacheFolder); // ensureDirSync рдмреЗрд╣рддрд░ рд╣реИ рдЬрдм рддрдХ рдХрд┐ рдЖрдк рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рди рд╣реЛрдВ рдХрд┐ рдЖрдк async ensureDir рдХрд╛ рдЙрдкрдпреЛрдЧ await рдХреЗ рд╕рд╛рде рд╕рд╣реА рдХрд░ рд░рд╣реЗ рд╣реИрдВред


        // Google Translate TTS URL рдмрдирд╛рдПрдВ
        // encodeURIComponent рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдЯреЗрдХреНрд╕реНрдЯ рдореЗрдВ рд╕реНрдкреЗрд╢рд▓ рдХреИрд░реЗрдХреНрдЯрд░ URL рдХреЛ рдЦрд░рд╛рдм рди рдХрд░реЗрдВред
        const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(textToSay)}&tl=${languageToSay}&client=tw-ob`;

        // рдмреЙрдЯ рдХреЗ рдЧреНрд▓реЛрдмрд▓ рдпреВрдЯрд┐рд▓рд┐рдЯреА рдлрдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдСрдбрд┐рдпреЛ рдлрд╛рдЗрд▓ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
        // рдпрд╣ рдЕрдкреЗрдХреНрд╖рд┐рдд рд╣реИ рдХрд┐ рдЖрдкрдХреЗ рдмреЙрдЯ рдХреЗ global.utils рдореЗрдВ downloadFile рдлрдВрдХреНрд╢рди рдореМрдЬреВрдж рд╣реЛред
        await global.utils.downloadFile(ttsUrl, audioFilePath);

        // рдСрдбрд┐рдпреЛ рдлрд╛рдЗрд▓ рдХреЛ рдореИрд╕реЗрдЬ рдЕрдЯреИрдЪрдореЗрдВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рднреЗрдЬреЗрдВ
        api.sendMessage({
            body: "", // рд╡реЙрдпрд╕ рдореИрд╕реЗрдЬ рдХреЗ рд╕рд╛рде рд╡реИрдХрд▓реНрдкрд┐рдХ рдХреИрдкреНрд╢рди рдЯреЗрдХреНрд╕реНрдЯ
            attachment: createReadStream(audioFilePath) // рдлрд╝рд╛рдЗрд▓ рдХреЛ рдкрдардиреАрдп рд╕реНрдЯреНрд░реАрдо рдХреЗ рд░реВрдк рдореЗрдВ рдЕрдЯреИрдЪ рдХрд░реЗрдВ
        }, event.threadID, (err) => {
            // рдореИрд╕реЗрдЬ рднреЗрдЬрдиреЗ рдХреЗ рдмрд╛рдж рдХрд╛ рдХреЙрд▓рдмреИрдХ рдлрдВрдХреНрд╢рди
            if (err) {
                console.error("ЁЯФ┤ Mirai Say Command (Google TTS): рд╡реЙрдпрд╕ рдореИрд╕реЗрдЬ рднреЗрдЬрдиреЗ рдореЗрдВ рдПрд░рд░:", err);
                api.sendMessage(`тЭМ рд╕реЙрд░реА, рд╡реЙрдпрд╕ рдореИрд╕реЗрдЬ рднреЗрдЬ рдирд╣реАрдВ рдкрд╛рдпрд╛ред`, event.threadID, event.messageID);
            } else {
                 console.log(`тЬЕ Mirai Say Command (Google TTS): рд╡реЙрдпрд╕ рдореИрд╕реЗрдЬ рднреЗрдЬрд╛ рдЧрдпрд╛ thread ${event.threadID} рдкрд░`);
            }

            // рдореИрд╕реЗрдЬ рднреЗрдЬрдиреЗ рдХреЗ рдмрд╛рдж рдЕрд╕реНрдерд╛рдпреА рдСрдбрд┐рдпреЛ рдлрд╛рдЗрд▓ рдХреЛ рдбрд┐рд▓реАрдЯ рдХрд░реЗрдВ
            try {
                 unlinkSync(audioFilePath); // Synchonously unlink the file
            } catch (unlinkErr) {
                 console.error("ЁЯФ┤ Mirai Say Command (Google TTS): рдЯреЗрдореНрдк рдлрд╛рдЗрд▓ рдбрд┐рд▓реАрдЯ рдХрд░рдиреЗ рдореЗрдВ рдПрд░рд░:", unlinkErr);
            }
        }, event.messageID); // рдореВрд▓ рдореИрд╕реЗрдЬ рдХрд╛ рдЬрд╡рд╛рдм рджреЗрдВ (рд╡реИрдХрд▓реНрдкрд┐рдХ)


    } catch (e) {
        // рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рджреМрд░рд╛рди рдХреЛрдИ рднреА рдПрд░рд░ рдкрдХрдбрд╝реЗрдВ (рдкрд╛рд░реНрд╕рд┐рдВрдЧ, рдбрд╛рдЙрдирд▓реЛрдб, рднреЗрдЬрдирд╛)
        console.error("ЁЯФ┤ Mirai Say Command (Google TTS): рдХрдорд╛рдВрдб рдЪрд▓рд╛рдиреЗ рдореЗрдВ рдПрд░рд░:", e);
        // рдпреВрдЬрд░ рдХреЛ рдПрд░рд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрддрд╛рдПрдВ
        return api.sendMessage(`тЭМ рдХрдорд╛рдВрдб рдЪрд▓рд╛рддреЗ рд╕рдордп рдПрдХ рдПрд░рд░ рдЖ рдЧрдИ: ${e.message}`, event.threadID, event.messageID);
        // рдпрджрд┐ рдбрд╛рдЙрдирд▓реЛрдб рдлреЗрд▓ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдлрд╝рд╛рдЗрд▓ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реЛрдЧреА, рдЗрд╕рд▓рд┐рдП рдбрд┐рд▓реАрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред
        // рдпрджрд┐ рдЖрдВрд╢рд┐рдХ рдбрд╛рдЙрдирд▓реЛрдб рд╣реБрдЖ рдФрд░ рдПрд░рд░ рдЖрдИ, рддреЛ рдЙрд╕реЗ рдбрд┐рд▓реАрдЯ рдХрд░рдирд╛ рдореБрд╢реНрдХрд┐рд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЗрд╕ catch рдмреНрд▓реЙрдХ рд╕реЗред
        // рдКрдкрд░ sendMeessage callback рдореЗрдВ unlinkSync рдЕрдзрд┐рдХрд╛рдВрд╢ рдорд╛рдорд▓реЛрдВ рдХреЛ рд╕рдВрднрд╛рд▓рддрд╛ рд╣реИред
    }
};
